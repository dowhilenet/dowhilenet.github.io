

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>iOS网络请求 | 这块显卡有点冷</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="baidu-site-verification" content="1ZsVVOmjoT" />
    <meta name="description" content="写在最前边的话:最近在做一个小的项目，因为是用来参加学校的比赛的，所以呢时间比较有限。希望用一些第三方的库来加快自己的进度。在这个过程中用到了Pitaya。这位大神告诉我，一些简单的东西能自己动手做尽量自己去动手做，这样才能称为一个伟大的程序员。顿时自己感觉到了自己的急躁，为什么不慢下来，增加自己的真的实力？
在大神的博客中有这么一个系列的博文，自己动手写一个iOS网络请求库。我呢，就跟着这片博文">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS网络请求">
<meta property="og:url" content="http://dowhile.net/2015/08/11/http/index.html">
<meta property="og:site_name" content="这块显卡有点冷">
<meta property="og:description" content="写在最前边的话:最近在做一个小的项目，因为是用来参加学校的比赛的，所以呢时间比较有限。希望用一些第三方的库来加快自己的进度。在这个过程中用到了Pitaya。这位大神告诉我，一些简单的东西能自己动手做尽量自己去动手做，这样才能称为一个伟大的程序员。顿时自己感觉到了自己的急躁，为什么不慢下来，增加自己的真的实力？
在大神的博客中有这么一个系列的博文，自己动手写一个iOS网络请求库。我呢，就跟着这片博文">
<meta property="og:updated_time" content="2015-08-12T11:58:34.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS网络请求">
<meta name="twitter:description" content="写在最前边的话:最近在做一个小的项目，因为是用来参加学校的比赛的，所以呢时间比较有限。希望用一些第三方的库来加快自己的进度。在这个过程中用到了Pitaya。这位大神告诉我，一些简单的东西能自己动手做尽量自己去动手做，这样才能称为一个伟大的程序员。顿时自己感觉到了自己的急躁，为什么不慢下来，增加自己的真的实力？
在大神的博客中有这么一个系列的博文，自己动手写一个iOS网络请求库。我呢，就跟着这片博文">
    
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

    

    <script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script>
</head>
<body>
<div id="container"> 
    <div id="wrap">
	

<header id="header" class="hdpage">
    
    <div id="header-outer" class="outer">
        
        <div id="header-inner" class="inner">
          <nav id="main-nav">
            <a id="main-nav-toggle" class="nav-icon"></a>
            
              <a class="main-nav-link" href="/">
                  
                  

                
                  Home
                </a>
            
              <a class="main-nav-link" href="/tags">
                  
                  

                
                  Tags
                </a>
            
              <a class="main-nav-link" href="/category">
                  
                  

                
                  Category
                </a>
            
              <a class="main-nav-link" href="/archives">
                  
                  

                
                  Archives
                </a>
            
              <a class="main-nav-link" href="http://weibo.com/71414225">
                  
                  

                
                  WeiBo
                </a>
            
              <a class="main-nav-link" href="https://github.com/dowhilenet">
                  
                  

                
                  Github
                </a>
            
          </nav>
          <nav id="sub-nav">
            
            <a id="nav-search-btn" class="nav-icon" title="Search"></a>
          </nav>
          <div id="search-form-wrap">
            <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://dowhile.net"></form>
          </div>
        </div>
    </div>
</header>

		<div class="outer">
		

    <article id="post-http" class="article article-type-post" itemscope itemprop="blogPost">
      <div class="article-meta">
        
          <header class="article-header">
            
  
    <a href="/2015/08/11/http/">
      <h1 class="article-title" itemprop="name">
        iOS网络请求
      </h1>
    </a>
  



          </header>
        

        <!--<a href="/2015/08/11/http/" class="article-date">
  <time datetime="2015-08-11T14:31:25.000Z" itemprop="datePublished">2015-08-11</time>
</a>-->
        <!-- 
  <div class="article-category">
    <a class="article-category-link" href="/categories/HTTP/">HTTP</a>
  </div>
 -->
      </div>
      <div class="article-inner">
            
            
              <!--<header class="article-header">
                
  
    <a href="/2015/08/11/http/">
      <h1 class="article-title" itemprop="name">
        iOS网络请求
      </h1>
    </a>
  



              </header>-->
            
            <div class="article-entry" itemprop="articleBody">
              <div class="page-toc">
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#写在最前边的话:"><span class="toc-number">1.</span> <span class="toc-text">写在最前边的话:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HTTP协议"><span class="toc-number">2.</span> <span class="toc-text">HTTP协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NSURLSession"><span class="toc-number">3.</span> <span class="toc-text">NSURLSession</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#开始写我们自己的网络请求库吧"><span class="toc-number">4.</span> <span class="toc-text">开始写我们自己的网络请求库吧</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#体验NSURLSession"><span class="toc-number">4.1.</span> <span class="toc-text">体验NSURLSession</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-_NSURL"><span class="toc-number">4.1.1.</span> <span class="toc-text">1. NSURL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-_NSURLRequest"><span class="toc-number">4.1.2.</span> <span class="toc-text">2. NSURLRequest</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-_NSURLResponse"><span class="toc-number">4.1.3.</span> <span class="toc-text">3. NSURLResponse</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建Framework"><span class="toc-number">4.2.</span> <span class="toc-text">创建Framework</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实现我们的库"><span class="toc-number">4.3.</span> <span class="toc-text">实现我们的库</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#未完！！！"><span class="toc-number"></span> <span class="toc-text">未完！！！</span></a>
              </div>
              
                <h2 id="写在最前边的话:">写在最前边的话:</h2><p>最近在做一个小的项目，因为是用来参加学校的比赛的，所以呢时间比较有限。希望用一些第三方的库来加快自己的进度。<br>在这个过程中用到了<a href="https://github.com/johnlui/Pitaya" target="_blank" rel="external">Pitaya</a>。这位大神告诉我，一些简单的东西能自己动手做尽量自己去动手做，这样才能称为一个伟大的程序员。顿时自己感觉到了自己的急躁，为什么不慢下来，增加自己的真的实力？</p>
<p>在大神的博客中有这么一个系列的博文，<a href="http://lvwenhan.com/ios/454.html" target="_blank" rel="external">自己动手写一个iOS网络请求库</a>。我呢，就跟着这片博文来自己动手写一个iOS网络请求库作为自己的开始吧。</p>
<p>原文的链接上边已经给出了，写的很详细自己就不多啰嗦了。我在这里写的呢，是自己的一些理解吧。</p>
<h2 id="HTTP协议"><code>HTTP</code>协议</h2><p>既然是一个网络请求库，那么肯定离不开http协议。那么http协议到底是个什么呢？其实呢我也不是很清楚。这里有一篇文章对<a href="http://www.cnblogs.com/li0803/archive/2008/11/03/1324746.html" target="_blank" rel="external">http</a>进行了讲解。如果对HTTP协议已经很了解了那就不用看了。如果有兴趣的话，可以再去了解一下HTTPS协议，毕竟iOS9苹果已经把网络请求默认成了HTTPS协议了，这种安全的方式以后毕竟定会成为主流。</p>
<h2 id="NSURLSession"><code>NSURLSession</code></h2><p>在iOS呢网络请求现在用的比较多的呢是<code>NSURLSession</code>，在2013的WWDC上，苹果推出了<code>NSURLConnection</code>的继承者<code>NSURLSession</code>。<a href="http://objccn.io/issue-5-4/" target="_blank" rel="external">objc中国</a>对这部分也有篇博文进行了详细的介绍。</p>
<h2 id="开始写我们自己的网络请求库吧">开始写我们自己的网络请求库吧</h2><h3 id="体验NSURLSession">体验<code>NSURLSession</code></h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">let</span> session = <span class="type">NSURLSession</span>.sharedSession()</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> request = <span class="type">NSURLRequest</span>(<span class="type">URL</span>:<span class="type">NSURL</span>(string:<span class="string">"https://baidu.com"</span>)!)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> task =  session.dataTaskWithRequest(request) &#123; (data, response, error) -&gt; <span class="type">Void</span> <span class="keyword">in</span></span><br><span class="line"></span><br><span class="line">            guard error == <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>&#123;<span class="built_in">print</span>(error?.description);<span class="keyword">return</span>&#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(data)</span><br><span class="line">        &#125;</span><br><span class="line">        task.resume()</span><br></pre></td></tr></table></figure>
<p>如果你对<code>NSURLSession</code>有一定的了解的话，上边的这段代码一定很好理解了。</p>
<p>我们先来对这几个类进行简单的一些了解。</p>
<h4 id="1-_NSURL">1. <code>NSURL</code></h4><p>可以通过NSURL对象轻松管理URL值并访问URL指向的内容。NSURL可以指向文件资源，也可以指向网络资源，同时在这两类资源类型的使用上没有任何的区别。</p>
<p>创建一个<code>NSURL</code>对象最常用的方法是<code>NSURL(string:&quot;https://baidu.com&quot;)</code></p>
<p><code>NSURL</code>对象提供了很多访问器方法来读取URL各个部分的值。每个访问器都可以只读访问URL的某一部分。<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> url = <span class="type">NSURL</span>(string: <span class="string">"https://baidu.com"</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> urlScheme = url?.scheme&#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Scheme:<span class="subst">\(urlScheme)</span>"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 输出https</span></span><br></pre></td></tr></table></figure></p>
<h4 id="2-_NSURLRequest">2. <code>NSURLRequest</code></h4><p>创建好<code>NSURL</code>对象之后，接下来就需要完成执行HTTP请求所需要的下一步了：创建NSURLRequest对象。NSURLRequest对象包含了加载URL内容所需要的信息，并且独立于URL中指定的协议。iOS中的URL加载系统支持HTTP、HTTPS、FTP、FILE URL内容的加载。</p>
<p>创建一个<code>NSURLRequest</code>对象<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> request = <span class="type">NSURLRequest</span>(<span class="type">URL</span>:<span class="type">NSURL</span>(string:<span class="string">"https://baidu.com"</span>)!)</span><br></pre></td></tr></table></figure></p>
<p>上边的一行代码创建的<code>NSURLRequest</code>对象<br>有些默认的行为:<code>The default cache policy is NSURLRequestUseProtocolCachePolicy and the default timeout interval is 60 seconds.</code></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> request = <span class="type">NSURLRequest</span>(<span class="type">URL</span>: url!, cachePolicy: <span class="type">NSURLRequestCachePolicy</span>.<span class="type">ReloadIgnoringLocalAndRemoteCacheData</span>, timeoutInterval: <span class="number">10</span>)</span><br></pre></td></tr></table></figure>
<p>可以使用上边的这个初始化方法，来制定自己想要的一些东西。如果你想要在创建之后对其做一些修改的话，创建<code>NSMutableURLRequest</code> 对象。</p>
<h4 id="3-_NSURLResponse">3. <code>NSURLResponse</code></h4><p><code>NSURLResponse</code>对象会在URL加载请求完毕之后返回。响应对象的内容根据请求的类型以及成功与否会有较大的变化。</p>
<p>MIMEType——结果数据的MIME类型。这个值来自于服务器，如果客户端框架认为服务器有错，那么可以修改；如果服务器没有提供，还可以由客户端框架提供。</p>
<p>expectedContentLength——该值可能由请求返回，也可能不反回，返回值可能与返回的内容实际大小不同。如果返回内容的大小未知，那么该值将等于<code>NSURLResponseUnknownLength</code></p>
<p>suggestedFilename——要么是服务器提供的内容文件名，要么来自于URL和MIME类型。</p>
<p>URL——返回内容的URL。由于重定向和标准化等原因，该URL可能和请求提供的URL不同。</p>
<p>URL加载系统提供了一个名为’NSHTTPURLResponse’的 <code>NSURLResponse</code> 子类，它包含了特定于HTTP请求的属性。</p>
<h3 id="创建Framework">创建<code>Framework</code></h3><p>既然我们要写一个库，我们直接就创建一个<code>Framework</code>工程。<br><code>Swift</code>是不支持静态库的，所以我们只能去选择<code>Cocoa Touch Framework</code>。</p>
<p>我这里工程的名字是<code>Lemon</code>。嘿嘿，因为大神的叫做<a href="https://github.com/johnlui/Pitaya" target="_blank" rel="external">Pitaya</a><br>我是照猫画虎。山寨一个！</p>
<p>工程创建好了之后我们创建一个空的<code>Swift</code>文件，因为毕竟我们是用<code>Swift</code>来写呀！</p>
<h3 id="实现我们的库">实现我们的库</h3><ol>
<li>创建请求方法的枚举类型</li>
</ol>
<p>在这里呢我先简单的使用两中请求方法，<code>GET</code>和<code>POST</code></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">enum</span> <span class="title">HTTPMethod</span>:<span class="title">String</span></span>&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">GET</span> = <span class="string">"GET"</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">POST</span> = <span class="string">"POST"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>创建我们的Lemon类</li>
</ol>
<p>首先呢看看我们都有哪些属性。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Lemon</span></span>&#123;</span><br><span class="line">  <span class="comment">//    MARK:  属性</span></span><br><span class="line">    <span class="keyword">let</span> method: <span class="type">String</span> <span class="comment">//网络请求的方法</span></span><br><span class="line">    <span class="keyword">var</span> params: <span class="type">Dictionary</span>&lt;<span class="type">String</span>,<span class="type">AnyObject</span>&gt; <span class="comment">//URL中的参数</span></span><br><span class="line">    <span class="keyword">var</span> cllback: (data: <span class="type">NSData</span>!, response: <span class="type">NSURLResponse</span>!, error: <span class="type">NSError</span>!) -&gt; <span class="type">Void</span> <span class="comment">//请求的返回闭包</span></span><br><span class="line">    <span class="keyword">let</span> session = <span class="type">NSURLSession</span>.sharedSession() <span class="comment">//NSURLSession 实例</span></span><br><span class="line">    <span class="keyword">let</span> url:<span class="type">String</span> <span class="comment">//访问的URL</span></span><br><span class="line">    <span class="keyword">var</span> request:<span class="type">NSMutableURLRequest</span>! <span class="comment">//NSURLRequest实例</span></span><br><span class="line">    <span class="keyword">var</span> task:<span class="type">NSURLSessionTask</span>!</span><br><span class="line"></span><br><span class="line">    <span class="comment">//    MARK: 初始化</span></span><br><span class="line">    <span class="keyword">init</span>(url:<span class="type">String</span>,method:<span class="type">String</span>,params:<span class="type">Dictionary</span>&lt;<span class="type">String</span>,<span class="type">AnyObject</span>&gt; = <span class="type">Dictionary</span>&lt;<span class="type">String</span>,<span class="type">AnyObject</span>&gt;(),callback:(data: <span class="type">NSData</span>!, response: <span class="type">NSURLResponse</span>!, error: <span class="type">NSError</span>!) -&gt; <span class="type">Void</span>)&#123;</span><br><span class="line">        <span class="keyword">self</span>.url = url</span><br><span class="line">        <span class="keyword">self</span>.request = <span class="type">NSMutableURLRequest</span>(<span class="type">URL</span>: <span class="type">NSURL</span>(string:url)!)</span><br><span class="line">        <span class="keyword">self</span>.method = method</span><br><span class="line">        <span class="keyword">self</span>.params = params</span><br><span class="line">        <span class="keyword">self</span>.cllback = callback</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来呢，我们创建一个类方法<code>request</code>。我们直接使用这个方法来进行网络请求:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 有参数的 request</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">request</span>(<span class="title">method</span>: <span class="title">HTTPMethod</span>,<span class="title">url</span>:<span class="title">String</span>,<span class="title">params</span>:<span class="title">Dictionary</span>&lt;<span class="title">String</span>,<span class="title">AnyObject</span>&gt; = <span class="title">Dictionary</span>&lt;<span class="title">String</span>,<span class="title">AnyObject</span>&gt;(),<span class="title">callback</span>:(<span class="title">data</span>:<span class="title">NSData</span>!,<span class="title">response</span>:<span class="title">NSURLResponse</span>!,<span class="title">error</span>:<span class="title">NSError</span>!)-&gt;<span class="title">Void</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">let</span> manager = <span class="type">Lemon</span>(url: url, method: method.rawValue, params: params, callback: callback)</span><br><span class="line">  manager.stare()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 没有参数的 request</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">request</span>(<span class="title">method</span>: <span class="title">HTTPMethod</span>,<span class="title">url</span>:<span class="title">String</span>,<span class="title">callback</span>:(<span class="title">data</span>:<span class="title">NSData</span>!,<span class="title">response</span>:<span class="title">NSURLResponse</span>!,<span class="title">error</span>:<span class="title">NSError</span>!)-&gt;<span class="title">Void</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">let</span> manager = <span class="type">Lemon</span>(url: url, method: method.rawValue, callback: callback)</span><br><span class="line">  manager.stare()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们对<code>request</code>方法进行了重载，一个是有参数的请求一个是没有参数的请求。在类方法中我们都执行了一个<code>Lemon</code>的实例方法<code>stare</code>。这个方法呢是开始我们的请求！接下里我们就要实现这个方法。</p>
<p>首先呢这里有三个方法是从 <code>Alamofire</code>借鉴来的，用来处理参数的。感兴趣的同学，可以仔细研究下这三个方法！<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">private <span class="func"><span class="keyword">func</span> <span class="title">buildParams</span><span class="params">(parameters: [String: AnyObject])</span></span> -&gt; <span class="type">String</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> components: [(<span class="type">String</span>, <span class="type">String</span>)] = []</span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> <span class="type">Array</span>(parameters.keys).<span class="built_in">sort</span>(&lt;) &#123;</span><br><span class="line">        <span class="keyword">let</span> value: <span class="type">AnyObject</span>! = parameters[key]</span><br><span class="line">        components += <span class="keyword">self</span>.queryComponents(key, value)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"&amp;"</span>.<span class="built_in">join</span>(components.<span class="built_in">map</span>&#123;<span class="string">"<span class="subst">\($<span class="number">0</span>)</span>=<span class="subst">\($<span class="number">1</span>)</span>"</span>&#125; <span class="keyword">as</span> [<span class="type">String</span>])</span><br><span class="line">&#125;</span><br><span class="line">private <span class="func"><span class="keyword">func</span> <span class="title">queryComponents</span><span class="params">(key: String, <span class="number">_</span> value: AnyObject)</span></span> -&gt; [(<span class="type">String</span>, <span class="type">String</span>)] &#123;</span><br><span class="line">    <span class="keyword">var</span> components: [(<span class="type">String</span>, <span class="type">String</span>)] = []</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> dictionary = value <span class="keyword">as</span>? [<span class="type">String</span>: <span class="type">AnyObject</span>] &#123;</span><br><span class="line">        <span class="keyword">for</span> (nestedKey, value) <span class="keyword">in</span> dictionary &#123;</span><br><span class="line">            components += queryComponents(<span class="string">"<span class="subst">\(key)</span>[<span class="subst">\(nestedKey)</span>]"</span>, value)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">let</span> array = value <span class="keyword">as</span>? [<span class="type">AnyObject</span>] &#123;</span><br><span class="line">        <span class="keyword">for</span> value <span class="keyword">in</span> array &#123;</span><br><span class="line">            components += queryComponents(<span class="string">"<span class="subst">\(key)</span>"</span>, value)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        components.extend([(escape(key), escape(<span class="string">"<span class="subst">\(value)</span>"</span>))])</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> components</span><br><span class="line">&#125;</span><br><span class="line">private <span class="func"><span class="keyword">func</span> <span class="title">escape</span><span class="params">(string: String)</span></span> -&gt; <span class="type">String</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> legalURLCharactersToBeEscaped: <span class="type">CFStringRef</span> = <span class="string">":&amp;=;+!@#$()',*"</span></span><br><span class="line">    <span class="keyword">return</span> <span class="type">CFURLCreateStringByAddingPercentEscapes</span>(<span class="literal">nil</span>, string, <span class="literal">nil</span>, legalURLCharactersToBeEscaped, <span class="type">CFStringBuiltInEncodings</span>.<span class="type">UTF8</span>.rawValue) <span class="keyword">as</span> <span class="type">String</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在开始写<code>stare</code>这个方法的时候我们要注意到一点，就是我们平时在浏览器中访问网页时会有这么种情况:</p>
<p><code>https://www.google.com/search?es_sm=106&amp;q=dowhile.net ....</code></p>
<p>这是我在用Google进行搜索时，在浏览器地址栏中显示的东西。你会发现请求的参数会在url后边直接显示着，这种请求的方法很明显就是<code>GET</code> 。因为如果是 <code>POST</code>的话，你就看不到那些参数了。</p>
<p>所以我们在进行有参数的<code>GET</code>请求的时候，把处理后的参数直接加到URL后边就ok！</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">private <span class="func"><span class="keyword">func</span> <span class="title">buildRequest</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">self</span>.method == <span class="string">"GET"</span> &amp;&amp; <span class="keyword">self</span>.params.<span class="built_in">count</span> &gt; <span class="number">0</span>&#123;</span><br><span class="line">        <span class="keyword">self</span>.request = <span class="type">NSMutableURLRequest</span>(<span class="type">URL</span>: <span class="type">NSURL</span>(string: url + <span class="string">"?"</span> + buildParams(<span class="keyword">self</span>.params))!)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    request.cachePolicy = <span class="type">NSURLRequestCachePolicy</span>.<span class="type">ReloadIgnoringLocalCacheData</span></span><br><span class="line">    request.<span class="type">HTTPMethod</span> = <span class="keyword">self</span>.method</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> !<span class="keyword">self</span>.params.isEmpty&#123;</span><br><span class="line">        request.addValue(<span class="string">"application/x-www-form-urlencoded"</span>, forHTTPHeaderField: <span class="string">"Content-Type"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private <span class="func"><span class="keyword">func</span> <span class="title">buildBody</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> !<span class="keyword">self</span>.params.isEmpty &amp;&amp; <span class="keyword">self</span>.method != <span class="string">"GET"</span> &#123;</span><br><span class="line">        request.<span class="type">HTTPBody</span> = buildParams(<span class="keyword">self</span>.params).nsdata</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private <span class="func"><span class="keyword">func</span> <span class="title">stareTask</span><span class="params">()</span></span>&#123;</span><br><span class="line">    task = session.dataTaskWithRequest(request, completionHandler: &#123; (data, response, error) -&gt; <span class="type">Void</span> <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">self</span>.cllback(data: data, response: response, error: error)</span><br><span class="line">    &#125;)</span><br><span class="line">    task.resume()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">stare</span><span class="params">()</span></span>&#123;</span><br><span class="line">    buildRequest()</span><br><span class="line">    buildBody()</span><br><span class="line">    stareTask()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>stare()</code> 中呢我们又有3个不同的方法来处理一些特定的功能！</p>
<h1 id="未完！！！">未完！！！</h1>
              
            </div>
            <footer class="article-footer">
              <a href="/2015/08/11/http/" class="article-date">
  <time datetime="2015-08-11T14:31:25.000Z" itemprop="datePublished">2015-08-11</time>
</a>
              <a data-url="http://dowhile.net/2015/08/11/http/" data-id="cidqqptq40037cn1xliwzm6ac" class="article-share-link">Share</a>
              
              
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HTTP/">HTTP</a></li></ul>

            </footer>
      </div>
      
        
<nav id="article-nav">
  
    <a href="/2015/08/13/jstype/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          JavaScript类型、值和变量
        
      </div>
    </a>
  
  
    <a href="/2015/08/02/firstangular/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">初识Angular</div>
    </a>
  
</nav>

      
    </article>
    <script type="text/javascript">
      window.onscroll = function(){ 
        $(function(){
          var $toc = $('.page-toc'),
              $article = $('.article-entry')
              toc_top = $toc.offset().top
              tocsub_width = $toc.children().width()
              article_height = $article.children().height()
              scroll_top = document.body.scrollTop
              screen_h = $(window).height()
              footer_top = $('.article-footer').offset().top - $(window).height()
              if(toc_top&&scroll_top&&scroll_top>toc_top&&scroll_top<footer_top){
                $toc.children().css({
                  "position": "fixed",
                  "height": (screen_h -20)+'px',
                  "overflow": "auto"
                })
                $article.css('margin-right',tocsub_width+'px')
              }else{
                $toc.children().css({
                  "position": "relative",
                  "height":'inherit',
                  "overflow": "auto"
                })
                $article.css('margin-right',0+'px')
              }
        })
      } 
    </script>








		</div>
		<footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
        <div class="left">
            &copy; 2015 这块显卡有点冷<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and Theme by <a href="https://github.com/jaywcjlove/hexoThemeKacper">hexoThemeKacper </a>
        </div>
        <div class="right">
            
        </div>
    </div>
  </div>
</footer>
<script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script>


<script type="text/javascript">
$(function(){
  var $img = $('.article-entry img'),
      $link = $img.css({
        "display":"inline-block"
      }).parent()

  if($link.parent().is("a")){
      $img.each(function(idx,item) {
      $(this).parent().attr('href',$(this).parent().parent().attr('href'))
    })
  }
})
</script>


<script src="/js/script.js" type="text/javascript"></script>

  	</div>
	<nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/category" class="mobile-nav-link">Category</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="http://weibo.com/71414225" class="mobile-nav-link">WeiBo</a>
  
    <a href="https://github.com/dowhilenet" class="mobile-nav-link">Github</a>
  
</nav>
</div>
</body>
</html>

